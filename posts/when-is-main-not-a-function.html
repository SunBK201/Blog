<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>main 通常是个函数，那么什么时候不是呢？- SunBK201</title>
  <meta name="author" content="SunBK201">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png">
  <link rel="stylesheet" href="/style.css">
  <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="SunBK201">
  <style>
    @import url('/fonts.css');
  </style>
</head>

<body>
  <header>
    <h1><a rel="author" href="/">SunBK201</a></h1>
    <nav>
      <a href="/about.html">About</a>
      <a href="/feed.xml" data-no-instant>RSS</a>
    </nav>
  </header>

  <main>
    <header>
      <time datetime="2021-06-18">2021-06-18</time>
      <h1>main 通常是个函数，那么什么时候不是呢？</h1>
    </header>

    <p>
      这始于我的同伴，尽管他已经知道如何编程，但却被迫参加我大学的计算机科学入门课程。我们跟他开玩笑说，他需要做一个可以运行的程序，但是评分的老师不能搞明白它是如何运行的。所以要求就是制作一个满足作业要求的程序，同时又要混淆视听，让评分人认为它不应该能运行起来。考虑到这一点，我开始回想起之前见过的C语言技巧库，其中有一点特别突出。我将通过这个技巧完成这个特殊的程序，这个技巧的想法来自一篇博客
      <a href="http://mainisusuallyafunction.blogspot.com/" target="_blank">main is usually a
        function</a>，这让我想到什么时候main不是一个函数？
    </p>

    <p>
      （你可以 <a href="http://jroweboy.github.io/downloads/2015-01-26-when-is-main-not-a-function/sources.zip"
        target="_blank">下载</a> 我在这里写的代码，注意我是在 64-bit Linux 进行编写的，因此你如果在其它平台运行，你或许需要进行调整。）
    </p>
    <p>
      我解决问题的过程通常和大多数程序员做的事情一样。第1步：在谷歌上搜索有关问题。第2步：点击第一页上每个看起来相关的链接。如果没有解决，尝试不同的查询，然后重复。值得庆幸的是，这个问题的<a
        href="http://stackoverflow.com/a/2252429/745719"
        target="_blank">答案</a>出现在Stackoverflow首次搜索中。在1984年，一个奇怪的程序赢得了IOCCC，其中main被声明为short main[] =
      {...}，不知何故，这个程序成功做了一些事情，并打印到屏幕上！这是一个很好的例子。不幸的是，它是为一个完全不同的架构和编译器编写的，所以我真的没有简单的方法来找出它做了什么，但从它只是一堆数字的事实来看，我可以推测，那里的数字只是一些短函数的编译二进制，链接器在寻找主函数时只是把它扔到它的位置。
    </p>
    <p>
      有了我们的假设，即程序的代码只是以数组形式表示的主函数的编译汇编，让我们看看是否可以通过制作一个小程序来复制这一现象，看看我们是否可以做到这一点。
    </p>
    <pre>
<code class="language-c" data-lang="c"><span style="color:#66d9ef">char</span> main[] <span style="color:#f92672">=</span> <span style="color:#e6db74">"Hello world!"</span>;</code>
</pre>
    <pre>
<code class="language-bash" data-lang="bash">$ gcc -Wall main_char.c -o first
main_char.c:1:6: warning: ‘main’ is usually a <span style="color:#66d9ef">function</span> <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
  char main<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">"Hello world!"</span>;
      ^
$ ./first
Segmentation fault</code>
</pre>
    <p>好了，它成功了… 因此我们的下一个目标是它能真正打印一些东西到屏幕上。回想一下我有限的ASM经验，我记得有不同的 section
      决定了不同东西的去处。与我们最相关的两个section是<code>.text</code>section 和
      <code>.data</code>section。<code>.text</code>包含所有可执行的代码，它是只读的，而<code>.data</code>包含可读和可写的代码，但它是不可执行的。在我们的例子中，我们只能填入main函数的代码，所以任何被放在<code>.data</code>section的东西都是不可行的。我们需要找到一种方法，在main函数内获得字符串
      “Hello world!” 并引用它。
    </p>

    <p>
      我开始研究如何用尽可能少的代码来打印东西。由于我知道目标系统将是64位Linux，我发现我可以调用系统的写入调用，它将会输出到屏幕上。现在回过头来看这段代码，我认为我不需要为此使用汇编，但同时，我真的很高兴我能够学到一些东西。开始写内联GCC
      ASM是最难的部分，但一旦我掌握了它，一切就开始变得容易了。
    </p>

    <p>
      不过，开始并不容易。事实证明，我通过谷歌能找到的大部分ASM知识都是以下内容：非常老旧，英特尔的语法，而且是32位系统。记住在我们的方案中，我们需要文件在64位系统上用gcc编译，不需要对编译器标志进行任何特殊的修改，所以这意味着没有特殊的编译标志，也不能包括任何自定义的链接步骤，我们要使用GCC内联AT&amp;T语法。我的大部分时间都花在了寻找有关64位系统的现代汇编的信息上了！我想这是一个很好的例子。也许是我的Google-fu有所欠缺
      :) 这一部分几乎都是试验和错误。我的目标只是用 gcc inline ASM 的 write syscall 向屏幕打印 “Hello world!"，为什么这么难呢？对于想学习如何做这个的人，我推荐以下网站：
      <a href="https://filippo.io/linux-syscall-table/" target="_blank">Linux syscall list</a>,
      <a href="http://wiki.osdev.org/Inline_Assembly" target="_blank">Intro to Inline ASM</a>,
      <a href="http://asm.sourceforge.net/articles/linasm.html#Syntax" target="_blank">Differences between Intel and
        AT&amp;T Syntax</a>.
    </p>
    <p>最终，我的ASM代码完成了，而且看起来它可以工作！记住，我的目标是制作一个main，它是一个打印 Hello World 的 ASM 数组。</p>
    <pre>
<code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>() {
    __asm__ (
        <span style="color:#75715e">// print Hello World
</span><span style="color:#75715e"></span>        <span style="color:#e6db74">"movl $1, %eax;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>  <span style="color:#75715e">/* 1 is the syscall number for write on 64-bit */</span>
        <span style="color:#e6db74">"movl $1, %ebx;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>  <span style="color:#75715e">/* 1 is stdout and is the first argument */</span>
        <span style="color:#e6db74">"movl $message, %esi;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span> <span style="color:#75715e">/* load the address of string into the second argument*/</span>
        <span style="color:#e6db74">"movl $13, %edx;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>  <span style="color:#75715e">/* third argument is the length of the string to print*/</span>
        <span style="color:#e6db74">"syscall;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>
        <span style="color:#75715e">// call exit (so it doesn't try to run the string Hello World)
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// maybe I could have just used ret instead?
</span><span style="color:#75715e"></span>        <span style="color:#e6db74">"movl $60,%eax;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>
        <span style="color:#e6db74">"xorl %ebx,%ebx; </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>
        <span style="color:#e6db74">"syscall;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>
        <span style="color:#75715e">// Store the Hello World inside the main function
</span><span style="color:#75715e"></span>        <span style="color:#e6db74">"message: .ascii </span><span style="color:#ae81ff">\"</span><span style="color:#e6db74">Hello World!</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\"</span><span style="color:#e6db74">;"</span>
    );
}</code>
</pre>

    <pre><code class="language-bash" data-lang="bash">$ gcc -Wall asm_main.c -o second
asm_main.c:1:6: warning: <span style="color:#66d9ef">return</span> type of ‘main’ is not ‘int’ <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
  void main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      ^
$ ./second
Hello World!
</code></pre>

    <p>YES! 它打印出来了! 现在让我们看看编译后的十六进制代码，它应该与我们写的ASM代码一一对应起来。</p>

    <pre>
<code class="language-c" data-lang="c">(gdb) disass main
  Dump of assembler code <span style="color:#66d9ef">for</span> function main:
      <span style="color:#ae81ff">0x00000000004004ed</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;:</span>     push   <span style="color:#f92672">%</span>rbp             ; Compiler inserted
      <span style="color:#ae81ff">0x00000000004004ee</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;:</span>     mov    <span style="color:#f92672">%</span>rsp,<span style="color:#f92672">%</span>rbp
      <span style="color:#ae81ff">0x00000000004004f1</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;:</span>     mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x1</span>,<span style="color:#f92672">%</span>eax        ; It<span style="color:#960050;background-color:#1e0010">'</span>s our code<span style="color:#f92672">!</span>
      <span style="color:#ae81ff">0x00000000004004f6</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;:</span>     mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x1</span>,<span style="color:#f92672">%</span>ebx
      <span style="color:#ae81ff">0x00000000004004fb</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">14</span><span style="color:#f92672">&gt;:</span>    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x400510</span>,<span style="color:#f92672">%</span>esi
      <span style="color:#ae81ff">0x0000000000400500</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">19</span><span style="color:#f92672">&gt;:</span>    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0xd</span>,<span style="color:#f92672">%</span>edx
      <span style="color:#ae81ff">0x0000000000400505</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">24</span><span style="color:#f92672">&gt;:</span>    syscall
      <span style="color:#ae81ff">0x0000000000400507</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">26</span><span style="color:#f92672">&gt;:</span>    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x3c</span>,<span style="color:#f92672">%</span>eax
      <span style="color:#ae81ff">0x000000000040050c</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">31</span><span style="color:#f92672">&gt;:</span>    xor    <span style="color:#f92672">%</span>ebx,<span style="color:#f92672">%</span>ebx
      <span style="color:#ae81ff">0x000000000040050e</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">33</span><span style="color:#f92672">&gt;:</span>    syscall
      <span style="color:#ae81ff">0x0000000000400510</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">35</span><span style="color:#f92672">&gt;:</span>    rex.W                   ; String hello world
      <span style="color:#ae81ff">0x0000000000400511</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">36</span><span style="color:#f92672">&gt;:</span>    gs                      ; it<span style="color:#960050;background-color:#1e0010">'</span>s garbled since
      <span style="color:#ae81ff">0x0000000000400512</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">37</span><span style="color:#f92672">&gt;:</span>    insb   (<span style="color:#f92672">%</span>dx),<span style="color:#f92672">%</span>es:(<span style="color:#f92672">%</span>rdi) ; it<span style="color:#960050;background-color:#1e0010">'</span>s not real ASM
      <span style="color:#ae81ff">0x0000000000400513</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">38</span><span style="color:#f92672">&gt;:</span>    insb   (<span style="color:#f92672">%</span>dx),<span style="color:#f92672">%</span>es:(<span style="color:#f92672">%</span>rdi) ; so it couldn<span style="color:#960050;background-color:#1e0010">'</span>t be
      <span style="color:#ae81ff">0x0000000000400514</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">39</span><span style="color:#f92672">&gt;:</span>    outsl  <span style="color:#f92672">%</span>ds:(<span style="color:#f92672">%</span>rsi),(<span style="color:#f92672">%</span>dx) ; disassembled
      <span style="color:#ae81ff">0x0000000000400515</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">40</span><span style="color:#f92672">&gt;:</span>    and    <span style="color:#f92672">%</span>dl,<span style="color:#ae81ff">0x6f</span>(<span style="color:#f92672">%</span>rdi)
      <span style="color:#ae81ff">0x0000000000400518</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">43</span><span style="color:#f92672">&gt;:</span>    jb     <span style="color:#ae81ff">0x400586</span>
      <span style="color:#ae81ff">0x000000000040051a</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">45</span><span style="color:#f92672">&gt;:</span>    and    <span style="color:#f92672">%</span>ecx,<span style="color:#f92672">%</span>fs:(<span style="color:#f92672">%</span>rdx)
      <span style="color:#ae81ff">0x000000000040051d</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">48</span><span style="color:#f92672">&gt;:</span>    pop    <span style="color:#f92672">%</span>rbp             ; Compiler<span style="color:#f92672">-</span>inserted
      <span style="color:#ae81ff">0x000000000040051e</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">49</span><span style="color:#f92672">&gt;:</span>    retq
End of assembler dump.</code>
</pre>

    <p>
      这看起来是个有戏的main，现在让我们去抓取它的十六进制内容，并将其作为字符串dump出去，看看是否能正常工作。我的方法是加载gdb，像这样在main处打印hex。上次我们拆解main的时候，看到它有49个字节长，所以可以用dump命令把十六进制保存到文件中。
    </p>

    <pre>
<code class="language-c" data-lang="c"><span style="color:#75715e"># example of how to print the hex
</span><span style="color:#75715e"></span>(gdb) x<span style="color:#f92672">/</span><span style="color:#ae81ff">49</span>xb main
<span style="color:#ae81ff">0x4004ed</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">&gt;:</span>    <span style="color:#ae81ff">0x55</span>    <span style="color:#ae81ff">0x48</span>    <span style="color:#ae81ff">0x89</span>    <span style="color:#ae81ff">0xe5</span>    <span style="color:#ae81ff">0xb8</span>    <span style="color:#ae81ff">0x01</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>
<span style="color:#ae81ff">0x4004f5</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;:</span>  <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0xbb</span>    <span style="color:#ae81ff">0x01</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0xbe</span>    <span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x4004fd</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0x05</span>    <span style="color:#ae81ff">0x40</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0xba</span>    <span style="color:#ae81ff">0x0d</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>
<span style="color:#ae81ff">0x400505</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0x0f</span>    <span style="color:#ae81ff">0x05</span>    <span style="color:#ae81ff">0xb8</span>    <span style="color:#ae81ff">0x3c</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x31</span>
<span style="color:#ae81ff">0x40050d</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">32</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0xdb</span>    <span style="color:#ae81ff">0x0f</span>    <span style="color:#ae81ff">0x05</span>    <span style="color:#ae81ff">0x48</span>    <span style="color:#ae81ff">0x65</span>    <span style="color:#ae81ff">0x6c</span>    <span style="color:#ae81ff">0x6c</span>    <span style="color:#ae81ff">0x6f</span>
<span style="color:#ae81ff">0x400515</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">40</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0x20</span>    <span style="color:#ae81ff">0x57</span>    <span style="color:#ae81ff">0x6f</span>    <span style="color:#ae81ff">0x72</span>    <span style="color:#ae81ff">0x6c</span>    <span style="color:#ae81ff">0x64</span>    <span style="color:#ae81ff">0x21</span>    <span style="color:#ae81ff">0x0a</span>
<span style="color:#ae81ff">0x40051d</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0x5d</span>
<span style="color:#75715e"># example of how to save it to a file
</span><span style="color:#75715e"></span>(gdb) dump memory hex.out main main<span style="color:#f92672">+</span><span style="color:#ae81ff">49</span></code>
</pre>

    <p>现在我们有了hex dump，我们可以用我知道的最简单的方法将它们全部转换成整数，那就是使用python。在Python 2.6和2.7中，你可以用下面的方法将其转换为方便我们使用的int数组。</p>

    <pre>
<code class="language-py" data-lang="py"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> array
<span style="color:#f92672">&gt;&gt;&gt;</span> hex_string <span style="color:#f92672">=</span> <span style="color:#e6db74">"554889E5B801000000BB01000000BE10054000BA0D0000000F05B83C00000031DB0F0548656C6C6F20576F726C64210A5D"</span><span style="color:#f92672">.</span>decode(<span style="color:#e6db74">"hex"</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> array<span style="color:#f92672">.</span>array(<span style="color:#e6db74">'B'</span>, hex_string)
array(<span style="color:#e6db74">'B'</span>, [<span style="color:#ae81ff">85</span>, <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">137</span>, <span style="color:#ae81ff">229</span>, <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">187</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">190</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">186</span>, <span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">219</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">87</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">114</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">93</span>])</code>
</pre>

    <p>我想如果我的bash foo和unix知识更丰富的话，我可以找到一个更简单的方法来做这件事，但在谷歌上搜索 “编译后的函数的十六进制转储
      “这样的东西，会得到几个关于如何用各种语言打印十六进制的问题。不管怎么说，我们现在有了一个逗号分隔的函数数组，所以让我们把它放到一个新的文件中。</p>

    <pre>
  <code class="language-c" data-lang="c"><span style="color:#66d9ef">char</span> main[] <span style="color:#f92672">=</span> {
    <span style="color:#ae81ff">85</span>,                 <span style="color:#75715e">// push   %rbp
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">137</span>, <span style="color:#ae81ff">229</span>,       <span style="color:#75715e">// mov    %rsp,%rbp
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,    <span style="color:#75715e">// mov    $0x1,%eax
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">187</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,    <span style="color:#75715e">// mov    $0x1,%ebx
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">190</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">0</span>,  <span style="color:#75715e">// mov    $0x400510,%esi
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">186</span>, <span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,   <span style="color:#75715e">// mov    $0xd,%edx
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>,              <span style="color:#75715e">// syscall
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,   <span style="color:#75715e">// mov    $0x3c,%eax
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">219</span>,            <span style="color:#75715e">// xor    %ebx,%ebx
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>,              <span style="color:#75715e">// syscall
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Hello world!\n
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">87</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">114</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">100</span>,
    <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">10</span>,             <span style="color:#75715e">// pop    %rbp
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">93</span>                  <span style="color:#75715e">// retq
</span><span style="color:#75715e"></span>};</code>
</pre>

    <pre>
<code class="language-bash" data-lang="bash">$ gcc -Wall compiled_array_main.c -o third
compiled_array_main.c:1:6: warning: ‘main’ is usually a <span style="color:#66d9ef">function</span> <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
  char main<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
      ^
$ ./third
Segmentation fault</code>
</pre>

    <p>Segfault！我做错了什么？是时候再次启动gdb，看看错误是什么了。由于main不再是一个函数，我们不能简单地使用<code>break main</code>来在那里设置断点。相反，我们可以使用
      <code>break _start</code> 在调用 libc runtime startup 的方法上获得一个断点（该函数调用 main），我们可以看到我们传递给
      <code>__libc_start_main</code> 的地址。
    </p>

    <pre>
<code class="language-c" data-lang="c"><span style="color:#960050;background-color:#1e0010">$</span> gdb .<span style="color:#f92672">/</span>third
(gdb) <span style="color:#66d9ef">break</span> _start
(gdb) run
(gdb) layout <span style="color:#66d9ef">asm</span>
    <span style="color:#960050;background-color:#1e0010">┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐</span>
 B<span style="color:#f92672">+&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400400</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">&gt;</span>                       xor    <span style="color:#f92672">%</span>ebp,<span style="color:#f92672">%</span>ebp                                                                       <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400402</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span>                     mov    <span style="color:#f92672">%</span>rdx,<span style="color:#f92672">%</span>r9                                                                        <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400405</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;</span>                     pop    <span style="color:#f92672">%</span>rsi                                                                            <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400406</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;</span>                     mov    <span style="color:#f92672">%</span>rsp,<span style="color:#f92672">%</span>rdx                                                                       <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400409</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span>                     and    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0xfffffffffffffff0</span>,<span style="color:#f92672">%</span>rsp                                                        <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x40040d</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">13</span><span style="color:#f92672">&gt;</span>                    push   <span style="color:#f92672">%</span>rax                                                                            <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x40040e</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">14</span><span style="color:#f92672">&gt;</span>                    push   <span style="color:#f92672">%</span>rsp                                                                            <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x40040f</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">15</span><span style="color:#f92672">&gt;</span>                    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x400560</span>,<span style="color:#f92672">%</span>r8                                                                   <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400416</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">22</span><span style="color:#f92672">&gt;</span>                    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x4004f0</span>,<span style="color:#f92672">%</span>rcx                                                                  <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x40041d</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">29</span><span style="color:#f92672">&gt;</span>                    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x601060</span>,<span style="color:#f92672">%</span>rdi                                                                  <span style="color:#960050;background-color:#1e0010">│</span>
    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400424</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">36</span><span style="color:#f92672">&gt;</span>                    callq  <span style="color:#ae81ff">0x4003e0</span> <span style="color:#f92672">&lt;</span>__libc_start_main<span style="color:#960050;background-color:#1e0010">@</span>plt<span style="color:#f92672">&gt;</span>                                                <span style="color:#960050;background-color:#1e0010">│</span></code>
</pre>
    <p>通过测试，我发现在<code>%rdi</code>上push的值是main的位置，但这次似乎有些不对劲。等一下，它把main放在了<code>.data</code>部分!
      早些时候我提到了<code>.text</code>是只读可执行代码的位置，而<code>.data</code>是不可执行的读写值的位置！这就是问题所在，这段代码试图运行被标记为不可执行的内存，这是导致segfault的原因。我怎么能让编译器相信我的
      “main"属于<code>.text</code>呢！？好吧，我的搜索结果是空的，我确信这就是道路的尽头。是时候收工了，game over。</p>

    <p>
      但那晚没有找到解决方案我就无法入睡。我继续搜索，再搜索，直到我在一个stackoverflow的帖子上找到一个非常明显和简单的解决方案，可惜我已经找不到网址了。我所要做的就是把main函数声明为<code>const</code>把它改成<code>const char main[] = {</code>
      从而让它进入正确的section，所以让我们再试着编译。</p>

    <pre>
<code class="language-bash" data-lang="bash">$ gcc -Wall const_array_main.c -o fourth
const_array_main.c:1:12: warning: ‘main’ is usually a <span style="color:#66d9ef">function</span> <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
  const char main<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
            ^
$ ./fourth
SL<span style="color:#f92672">)</span>.....]</code>
</pre>

    <p>emmmm, 它现在在做什么! 是时候再次使用gdb，看看发生了什么。</p>
    <pre>
<code class="language-c" data-lang="c">gdb .<span style="color:#f92672">/</span>fourth
(gdb) <span style="color:#66d9ef">break</span> _start
(gdb) run
(gdb) layout <span style="color:#66d9ef">asm</span></code>
</pre>
    <p>所以看一下代码，我们可以看到main的地址在ASM的<code>_start</code>指令中，在我的机器上看起来是这样的 <code>mov $0x4005a0,%rdi</code>
      我们可以用这个在main上设置一个断点，通过做<code>break *0x4005a0</code>，然后用<code>c</code>继续执行。</p>

    <pre>
<code class="language-c" data-lang="c">(gdb) <span style="color:#66d9ef">break</span> <span style="color:#f92672">*</span><span style="color:#ae81ff">0x4005a0</span>
(gdb) c
(gdb) x<span style="color:#f92672">/</span><span style="color:#ae81ff">49</span>i <span style="color:#960050;background-color:#1e0010">$</span>pc     <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">$</span>pc is the current executing instruction
...
    <span style="color:#ae81ff">0x4005a4</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;:</span>   mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x1</span>,<span style="color:#f92672">%</span>eax
    <span style="color:#ae81ff">0x4005a9</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;:</span>   mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x1</span>,<span style="color:#f92672">%</span>ebx
    <span style="color:#ae81ff">0x4005ae</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">14</span><span style="color:#f92672">&gt;:</span>  mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x400510</span>,<span style="color:#f92672">%</span>esi
    <span style="color:#ae81ff">0x4005b3</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">19</span><span style="color:#f92672">&gt;:</span>  mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0xd</span>,<span style="color:#f92672">%</span>edx
    <span style="color:#ae81ff">0x4005b8</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span><span style="color:#f92672">&gt;:</span>  syscall
...</code>
</pre>

    <p>
      我剪掉了一些不重要的汇编。如果你没有注意到出错的地方，push到print的地址<code>(0x400510)</code>并不是我们存储字符串<code> "Hello world!\n "</code>的地址<code>(0x4005c3)</code>！它实际上仍然指向原始编译的可执行文件中的计算位置，而不是使用相对寻址来打印它。这意味着我们需要修改汇编代码，以便加载相对于当前地址的字符串的地址。就目前而言，在32位代码中完成这个任务相当困难，但幸运的是我们使用的是64位ASM，所以我们可以使用lea指令来轻松完成。
    </p>

    <pre>
<code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>() {
  __asm__ (
        <span style="color:#75715e">// print Hello World
</span><span style="color:#75715e"></span>        <span style="color:#e6db74">"movl $1, %eax;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>  <span style="color:#75715e">/* 1 is the syscall number for write */</span>
        <span style="color:#e6db74">"movl $1, %ebx;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>  <span style="color:#75715e">/* 1 is stdout and is the first argument */</span>
        <span style="color:#75715e">// "movl $message, %esi;\n" /* load the address of string into the second argument*/
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// instead use this to load the address of the string
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// as 16 bytes from the current instruction
</span><span style="color:#75715e"></span>        <span style="color:#e6db74">"leal 16(%eip), %esi;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>
        <span style="color:#e6db74">"movl $13, %edx;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>  <span style="color:#75715e">/* third argument is the length of the string to print*/</span>
        <span style="color:#e6db74">"syscall;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>
        <span style="color:#75715e">// call exit (so it doesn't try to run the string Hello World
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// maybe I could have just used ret instead
</span><span style="color:#75715e"></span>        <span style="color:#e6db74">"movl $60,%eax;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>
        <span style="color:#e6db74">"xorl %ebx,%ebx; </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>
        <span style="color:#e6db74">"syscall;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>
        <span style="color:#75715e">// Store the Hello World inside the main function
</span><span style="color:#75715e"></span>        <span style="color:#e6db74">"message: .ascii </span><span style="color:#ae81ff">\"</span><span style="color:#e6db74">Hello World!</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\"</span><span style="color:#e6db74">;"</span>
    );
}</code>
</pre>

    <pre>
<code class="language-bash" data-lang="bash">$ gcc -Wall relative_str_asm.c -o fifth
relative_str_asm.c:1:6: warning: <span style="color:#66d9ef">return</span> type of ‘main’ is not ‘int’ <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
  void main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      ^
$ ./fifth
Hello World!</code>
</pre>

    <p>
      现在我们可以使用前面讨论过的技术，将十六进制的值提取成一个整数数组。但是这一次，我想通过使用整整4个字节的ints来使它变得更有伪装性和技巧性。我们可以通过在gdb中把信息作为一个int打印出来，而不是把十六进制转储到一个文件中，然后再复制粘贴到程序中。
    </p>

    <pre><code class="language-bash" data-lang="bash">gdb ./fifth
<span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/13dw main
0x4004ed &lt;main&gt;:    -443987883  <span style="color:#ae81ff">440</span> <span style="color:#ae81ff">113408</span>  -1922629632
0x4004fd &lt;main+16&gt;: <span style="color:#ae81ff">4149</span>    <span style="color:#ae81ff">899584</span>  <span style="color:#ae81ff">84869120</span>    <span style="color:#ae81ff">15544</span>
0x40050d &lt;main+32&gt;: <span style="color:#ae81ff">266023168</span>   <span style="color:#ae81ff">1818576901</span>  <span style="color:#ae81ff">1461743468</span>  <span style="color:#ae81ff">1684828783</span>
0x40051d &lt;main+48&gt;: -1017312735
</code></pre>

    <p>
      我选择了数字13，因为main的长度为49字节，为了安全起见，49/4取整为13。由于我们提前退出了这个函数，所以应该不会有什么影响。现在剩下的就是把这个复制粘贴到我们的<code>compiled_array_main.c</code>中并运行它。
    </p>
    <pre><code class="language-c" data-lang="c"><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> main[] <span style="color:#f92672">=</span> {
  <span style="color:#f92672">-</span><span style="color:#ae81ff">443987883</span>, <span style="color:#ae81ff">440</span>, <span style="color:#ae81ff">113408</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1922629632</span>,
  <span style="color:#ae81ff">4149</span>, <span style="color:#ae81ff">899584</span>, <span style="color:#ae81ff">84869120</span>, <span style="color:#ae81ff">15544</span>,
  <span style="color:#ae81ff">266023168</span>, <span style="color:#ae81ff">1818576901</span>, <span style="color:#ae81ff">1461743468</span>, <span style="color:#ae81ff">1684828783</span>,
  <span style="color:#f92672">-</span><span style="color:#ae81ff">1017312735</span>
};
</code></pre>

    <pre>
<code class="language-bash" data-lang="bash">$ gcc -Wall final_array.c -o sixth
final_array.c:1:11: warning: ‘main’ is usually a <span style="color:#66d9ef">function</span> <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
  const int main<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
            ^
$ ./sixth
Hello World!
</code></pre>
    <p>自始至终，我们都忽略了关于<code>warning: ‘main’ is usually a function</code>的警告信息 :)</p>
    <p>我猜，当我的朋友交出这样的作业时，会因为糟糕的编码风格而扣分，然而并不会说别的 ......</p>

    <p>This is a version from
      <a href="http://jroweboy.github.io/about/" target="_blank">James Rowe</a>.
    </p>
  </main>

  <footer>
    <span>Copyright &copy; SunBK201 Ushiromiya</span>
    <a hidden href="https://www.sunbk201.site"><img
        src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fwww.sunbk201.site&count_bg=%2379C83D&title_bg=%234F4F4F&icon=bloglovin.svg&icon_color=%23E7E7E7&title=hits&edge_flat=false" />
    </a>
  </footer>
  
  <script src="/instantclick.min.js" data-no-instant></script>
  <script data-no-instant>InstantClick.init();</script>
</body>

</html>