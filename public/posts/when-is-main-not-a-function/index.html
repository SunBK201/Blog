<!DOCTYPE html>
<html><head>
    <meta charset="UTF-8">
    <title>SunBK201</title>
    <meta name="author" content="SunBK201">
    <meta property="og:title" content="SunBK201" />
    <meta property="og:type" content="website">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="shortcut icon" href="/favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="stylesheet" href="/css/style.css">
    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="SunBK201">
    <style>
        @import url('/css/fonts.css');
    </style>
    <svg xmlns="http://www.w3.org/2000/svg" class="hidden">
        <filter id="x">
            <feTurbulence baseFrequency="0.01 0.02" numOctaves="2" result="t0"></feTurbulence>
            <feDisplacementMap in="SourceGraphic" in2="t0" scale="4" result="d0"></feDisplacementMap>
            <feComposite in="SourceGraphic" in2="d0" operator="atop" result="0"></feComposite>
            <feTurbulence baseFrequency="1" numOctaves="2" result="t1"></feTurbulence>
            <feDisplacementMap in="0" in2="t1" scale="1" result="d1"></feDisplacementMap>
            <feComposite in="0" in2="d1" operator="atop" result="1"></feComposite>
            <feOffset in="1" dx="-3" dy="-3" />
        </filter>
    </svg>
</head><body><header>
    <h1><a rel="author" href="/">SunBK201</a></h1>
    <nav>
        <a href="/about">About</a>
        <a href="/feed.xml" data-no-instant>RSS</a>
    </nav>
</header>
<main>
    <header>
        <time datetime="2021-06-18 00:00:00 &#43;0000 UTC">2021-06-18</time>
        <h1>main 通常是个函数，那么什么时候不是呢？</h1>
    </header>
    <p>这始于我的同伴，尽管他已经知道如何编程，但却被迫参加我大学的计算机科学入门课程。我们跟他开玩笑说，他需要做一个可以运行的程序，但是评分的老师不能搞明白它是如何运行的。所以要求就是制作一个满足作业要求的程序，同时又要混淆视听，让评分人认为它不应该能运行起来。考虑到这一点，我开始回想起之前见过的C语言技巧库，其中有一点特别突出。我将通过这个技巧完成这个特殊的程序，这个技巧的想法来自一篇博客 <a href="http://mainisusuallyafunction.blogspot.com/">main is usually a function</a>，这让我想到什么时候 main 不是一个函数？</p>
<p>（你可以<code>下载</code>我在这里写的代码，注意我是在 64-bit Linux 进行编写的，因此你如果在其它平台运行，你或许需要进行调整。）</p>
<p>我解决问题的过程通常和大多数程序员做的事情一样。第 1 步：在谷歌上搜索有关问题。第 2 步：点击第一页上每个看起来相关的链接。如果没有解决，尝试不同的查询，然后重复。值得庆幸的是，这个问题的<a href="http://stackoverflow.com/a/2252429/745719">答案</a>出现在 Stackoverflow 首次搜索中。在 1984 年，一个奇怪的程序赢得了 IOCCC，其中 main 被声明为 <code>short main[] = {...}</code>，不知何故，这个程序成功做了一些事情，并打印到屏幕上！这是一个很好的例子。不幸的是，它是为一个完全不同的架构和编译器编写的，所以我真的没有简单的方法来找出它做了什么，但从它只是一堆数字的事实来看，我可以推测，那里的数字只是一些短函数的编译二进制，链接器在寻找主函数时只是把它扔到它的位置。</p>
<p>有了我们的假设，即程序的代码只是以数组形式表示的主函数的编译汇编，让我们看看是否可以通过制作一个小程序来复制这一现象，看看我们是否可以做到这一点。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> main[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello world!&#34;</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcc -Wall main_char.c -o first
</span></span><span style="display:flex;"><span>main_char.c:1:6: warning: ‘main’ is usually a <span style="color:#66d9ef">function</span> <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  char main<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello world!&#34;</span>;
</span></span><span style="display:flex;"><span>      ^
</span></span><span style="display:flex;"><span>$ ./first
</span></span><span style="display:flex;"><span>Segmentation fault
</span></span></code></pre></div><p>好了，它成功了… 因此我们的下一个目标是它能真正打印一些东西到屏幕上。回想一下我有限的 ASM 经验，我记得有不同的 section 决定了不同东西的去处。与我们最相关的两个section是.text section 和 .datasection。.text 包含所有可执行的代码，它是只读的，而 .data 包含可读和可写的代码，但它是不可执行的。在我们的例子中，我们只能填入 main 函数的代码，所以任何被放在 .data section 的东西都是不可行的。我们需要找到一种方法，在 main 函数内获得字符串 “Hello world!” 并引用它。</p>
<p>我开始研究如何用尽可能少的代码来打印东西。由于我知道目标系统将是64位Linux，我发现我可以调用系统的写入调用，它将会输出到屏幕上。现在回过头来看这段代码，我认为我不需要为此使用汇编，但同时，我真的很高兴我能够学到一些东西。开始写内联 GCC ASM 是最难的部分，但一旦我掌握了它，一切就开始变得容易了。</p>
<p>不过，开始并不容易。事实证明，我通过谷歌能找到的大部分ASM知识都是以下内容：非常老旧，英特尔的语法，而且是 32 位系统。记住在我们的方案中，我们需要文件在 64 位系统上用 gcc 编译，不需要对编译器标志进行任何特殊的修改，所以这意味着没有特殊的编译标志，也不能包括任何自定义的链接步骤，我们要使用 GCC 内联 AT&amp;T 语法。我的大部分时间都花在了寻找有关64位系统的现代汇编的信息上了！我想这是一个很好的例子。也许是我的 Google-fu 有所欠缺 :) 这一部分几乎都是试验和错误。我的目标只是用 gcc inline ASM 的 write syscall 向屏幕打印 “Hello world!&quot;，为什么这么难呢？对于想学习如何做这个的人，我推荐以下网站： Linux syscall list, Intro to Inline ASM, Differences between Intel and AT&amp;T Syntax.</p>
<p>最终，我的 ASM 代码完成了，而且看起来它可以工作！记住，我的目标是制作一个 main，它是一个打印 Hello World 的 ASM 数组。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__asm__</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// print Hello World
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#34;movl $1, %eax;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>  <span style="color:#75715e">/* 1 is the syscall number for write on 64-bit */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;movl $1, %ebx;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>  <span style="color:#75715e">/* 1 is stdout and is the first argument */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;movl $message, %esi;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e">/* load the address of string into the second argument*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;movl $13, %edx;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>  <span style="color:#75715e">/* third argument is the length of the string to print*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;syscall;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// call exit (so it doesn&#39;t try to run the string Hello World)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// maybe I could have just used ret instead?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#34;movl $60,%eax;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;xorl %ebx,%ebx; </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;syscall;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Store the Hello World inside the main function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#34;message: .ascii </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">Hello World!</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">;&#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcc -Wall asm_main.c -o second
</span></span><span style="display:flex;"><span>asm_main.c:1:6: warning: <span style="color:#66d9ef">return</span> type of ‘main’ is not ‘int’ <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  void main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      ^
</span></span><span style="display:flex;"><span>$ ./second
</span></span><span style="display:flex;"><span>Hello World!
</span></span></code></pre></div><p>YES! 它打印出来了! 现在让我们看看编译后的十六进制代码，它应该与我们写的 ASM 代码一一对应起来。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>(gdb) disass main
</span></span><span style="display:flex;"><span>  Dump of assembler code <span style="color:#66d9ef">for</span> function main:
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x00000000004004ed</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;:</span>     push   <span style="color:#f92672">%</span>rbp             ; Compiler inserted
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x00000000004004ee</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;:</span>     mov    <span style="color:#f92672">%</span>rsp,<span style="color:#f92672">%</span>rbp
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x00000000004004f1</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;:</span>     mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x1</span>,<span style="color:#f92672">%</span>eax        ; It<span style="color:#960050;background-color:#1e0010">&#39;</span>s our code<span style="color:#f92672">!</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x00000000004004f6</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;:</span>     mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x1</span>,<span style="color:#f92672">%</span>ebx
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x00000000004004fb</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">14</span><span style="color:#f92672">&gt;:</span>    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x400510</span>,<span style="color:#f92672">%</span>esi
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400500</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">19</span><span style="color:#f92672">&gt;:</span>    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0xd</span>,<span style="color:#f92672">%</span>edx
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400505</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">24</span><span style="color:#f92672">&gt;:</span>    syscall
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400507</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">26</span><span style="color:#f92672">&gt;:</span>    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x3c</span>,<span style="color:#f92672">%</span>eax
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x000000000040050c</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">31</span><span style="color:#f92672">&gt;:</span>    xor    <span style="color:#f92672">%</span>ebx,<span style="color:#f92672">%</span>ebx
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x000000000040050e</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">33</span><span style="color:#f92672">&gt;:</span>    syscall
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400510</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">35</span><span style="color:#f92672">&gt;:</span>    rex.W                   ; String hello world
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400511</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">36</span><span style="color:#f92672">&gt;:</span>    gs                      ; it<span style="color:#960050;background-color:#1e0010">&#39;</span>s garbled since
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400512</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">37</span><span style="color:#f92672">&gt;:</span>    <span style="color:#a6e22e">insb</span>   (<span style="color:#f92672">%</span>dx),<span style="color:#f92672">%</span>es:(<span style="color:#f92672">%</span>rdi) ; it<span style="color:#960050;background-color:#1e0010">&#39;</span>s not real ASM
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400513</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">38</span><span style="color:#f92672">&gt;:</span>    <span style="color:#a6e22e">insb</span>   (<span style="color:#f92672">%</span>dx),<span style="color:#f92672">%</span>es:(<span style="color:#f92672">%</span>rdi) ; so it couldn<span style="color:#960050;background-color:#1e0010">&#39;</span>t be
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400514</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">39</span><span style="color:#f92672">&gt;:</span>    outsl  <span style="color:#f92672">%</span>ds:(<span style="color:#f92672">%</span>rsi),(<span style="color:#f92672">%</span>dx) ; disassembled
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400515</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">40</span><span style="color:#f92672">&gt;:</span>    and    <span style="color:#f92672">%</span>dl,<span style="color:#ae81ff">0x6f</span>(<span style="color:#f92672">%</span>rdi)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x0000000000400518</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">43</span><span style="color:#f92672">&gt;:</span>    jb     <span style="color:#ae81ff">0x400586</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x000000000040051a</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">45</span><span style="color:#f92672">&gt;:</span>    and    <span style="color:#f92672">%</span>ecx,<span style="color:#f92672">%</span>fs:(<span style="color:#f92672">%</span>rdx)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x000000000040051d</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">48</span><span style="color:#f92672">&gt;:</span>    pop    <span style="color:#f92672">%</span>rbp             ; Compiler<span style="color:#f92672">-</span>inserted
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x000000000040051e</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">49</span><span style="color:#f92672">&gt;:</span>    retq
</span></span><span style="display:flex;"><span>End of assembler dump.
</span></span></code></pre></div><p>这看起来是个有戏的 main，现在让我们去抓取它的十六进制内容，并将其作为字符串 dump 出去，看看是否能正常工作。我的方法是加载 gdb，像这样在 main 处打印 hex。上次我们拆解 main 的时候，看到它有 49 个字节长，所以可以用 dump 命令把十六进制保存到文件中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e"># example of how to print the hex
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>(gdb) x<span style="color:#f92672">/</span><span style="color:#ae81ff">49</span>xb main
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x4004ed</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">&gt;:</span>    <span style="color:#ae81ff">0x55</span>    <span style="color:#ae81ff">0x48</span>    <span style="color:#ae81ff">0x89</span>    <span style="color:#ae81ff">0xe5</span>    <span style="color:#ae81ff">0xb8</span>    <span style="color:#ae81ff">0x01</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x4004f5</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;:</span>  <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0xbb</span>    <span style="color:#ae81ff">0x01</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0xbe</span>    <span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x4004fd</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0x05</span>    <span style="color:#ae81ff">0x40</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0xba</span>    <span style="color:#ae81ff">0x0d</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x400505</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0x0f</span>    <span style="color:#ae81ff">0x05</span>    <span style="color:#ae81ff">0xb8</span>    <span style="color:#ae81ff">0x3c</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x00</span>    <span style="color:#ae81ff">0x31</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x40050d</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">32</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0xdb</span>    <span style="color:#ae81ff">0x0f</span>    <span style="color:#ae81ff">0x05</span>    <span style="color:#ae81ff">0x48</span>    <span style="color:#ae81ff">0x65</span>    <span style="color:#ae81ff">0x6c</span>    <span style="color:#ae81ff">0x6c</span>    <span style="color:#ae81ff">0x6f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x400515</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">40</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0x20</span>    <span style="color:#ae81ff">0x57</span>    <span style="color:#ae81ff">0x6f</span>    <span style="color:#ae81ff">0x72</span>    <span style="color:#ae81ff">0x6c</span>    <span style="color:#ae81ff">0x64</span>    <span style="color:#ae81ff">0x21</span>    <span style="color:#ae81ff">0x0a</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x40051d</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">0x5d</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># example of how to save it to a file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>(gdb) dump memory hex.out main main<span style="color:#f92672">+</span><span style="color:#ae81ff">49</span>
</span></span></code></pre></div><p>现在我们有了 hex dump，我们可以用我知道的最简单的方法将它们全部转换成整数，那就是使用 python。在Python 2.6 和 2.7中，你可以用下面的方法将其转换为方便我们使用的 int 数组。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> array
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> hex_string <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;554889E5B801000000BB01000000BE10054000BA0D0000000F05B83C00000031DB0F0548656C6C6F20576F726C64210A5D&#34;</span><span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;hex&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> array<span style="color:#f92672">.</span>array(<span style="color:#e6db74">&#39;B&#39;</span>, hex_string)
</span></span><span style="display:flex;"><span>array(<span style="color:#e6db74">&#39;B&#39;</span>, [<span style="color:#ae81ff">85</span>, <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">137</span>, <span style="color:#ae81ff">229</span>, <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">187</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">190</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">186</span>, <span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">219</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">87</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">114</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">93</span>])
</span></span></code></pre></div><p>我想如果我的 bash foo 和 unix 知识更丰富的话，我可以找到一个更简单的方法来做这件事，但在谷歌上搜索 “编译后的函数的十六进制转储 “这样的东西，会得到几个关于如何用各种语言打印十六进制的问题。不管怎么说，我们现在有了一个逗号分隔的函数数组，所以让我们把它放到一个新的文件中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> main[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">85</span>,                 <span style="color:#75715e">// push   %rbp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">137</span>, <span style="color:#ae81ff">229</span>,       <span style="color:#75715e">// mov    %rsp,%rbp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,    <span style="color:#75715e">// mov    $0x1,%eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">187</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,    <span style="color:#75715e">// mov    $0x1,%ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">190</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">0</span>,  <span style="color:#75715e">// mov    $0x400510,%esi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">186</span>, <span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,   <span style="color:#75715e">// mov    $0xd,%edx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>,              <span style="color:#75715e">// syscall
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,   <span style="color:#75715e">// mov    $0x3c,%eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">219</span>,            <span style="color:#75715e">// xor    %ebx,%ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>,              <span style="color:#75715e">// syscall
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Hello world!\n
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">87</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">114</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">100</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">10</span>,             <span style="color:#75715e">// pop    %rbp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">93</span>                  <span style="color:#75715e">// retq
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcc -Wall compiled_array_main.c -o third
</span></span><span style="display:flex;"><span>compiled_array_main.c:1:6: warning: ‘main’ is usually a <span style="color:#66d9ef">function</span> <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  char main<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      ^
</span></span><span style="display:flex;"><span>$ ./third
</span></span><span style="display:flex;"><span>Segmentation fault
</span></span></code></pre></div><p>Segfault！我做错了什么？是时候再次启动 gdb，看看错误是什么了。由于 main 不再是一个函数，我们不能简单地使用 break main 来在那里设置断点。相反，我们可以使用 break _start 在调用 libc runtime startup 的方法上获得一个断点（该函数调用 main），我们可以看到我们传递给 __libc_start_main 的地址。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> gdb .<span style="color:#f92672">/</span><span style="color:#a6e22e">third</span>
</span></span><span style="display:flex;"><span>(gdb) <span style="color:#66d9ef">break</span> <span style="color:#a6e22e">_start</span>
</span></span><span style="display:flex;"><span>(gdb) <span style="color:#a6e22e">run</span>
</span></span><span style="display:flex;"><span>(gdb) layout <span style="color:#66d9ef">asm</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐</span>
</span></span><span style="display:flex;"><span> B<span style="color:#f92672">+&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400400</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">&gt;</span>                       xor    <span style="color:#f92672">%</span>ebp,<span style="color:#f92672">%</span>ebp                                                                       <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400402</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span>                     mov    <span style="color:#f92672">%</span>rdx,<span style="color:#f92672">%</span>r9                                                                        <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400405</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;</span>                     pop    <span style="color:#f92672">%</span>rsi                                                                            <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400406</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;</span>                     mov    <span style="color:#f92672">%</span>rsp,<span style="color:#f92672">%</span>rdx                                                                       <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400409</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span>                     and    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0xfffffffffffffff0</span>,<span style="color:#f92672">%</span>rsp                                                        <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x40040d</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">13</span><span style="color:#f92672">&gt;</span>                    push   <span style="color:#f92672">%</span>rax                                                                            <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x40040e</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">14</span><span style="color:#f92672">&gt;</span>                    push   <span style="color:#f92672">%</span>rsp                                                                            <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x40040f</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">15</span><span style="color:#f92672">&gt;</span>                    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x400560</span>,<span style="color:#f92672">%</span>r8                                                                   <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400416</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">22</span><span style="color:#f92672">&gt;</span>                    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x4004f0</span>,<span style="color:#f92672">%</span>rcx                                                                  <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x40041d</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">29</span><span style="color:#f92672">&gt;</span>                    mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x601060</span>,<span style="color:#f92672">%</span>rdi                                                                  <span style="color:#960050;background-color:#1e0010">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">0x400424</span> <span style="color:#f92672">&lt;</span>_start<span style="color:#f92672">+</span><span style="color:#ae81ff">36</span><span style="color:#f92672">&gt;</span>                    callq  <span style="color:#ae81ff">0x4003e0</span> <span style="color:#f92672">&lt;</span>__libc_start_main<span style="color:#960050;background-color:#1e0010">@</span>plt<span style="color:#f92672">&gt;</span>                                                <span style="color:#960050;background-color:#1e0010">│</span>
</span></span></code></pre></div><p>通过测试，我发现在 %rdi 上 push 的值是 main 的位置，但这次似乎有些不对劲。等一下，它把 main 放在了 .data 部分! 早些时候我提到了 .text 是只读可执行代码的位置，而 .data 是不可执行的读写值的位置！这就是问题所在，这段代码试图运行被标记为不可执行的内存，这是导致 segfault 的原因。我怎么能让编译器相信我的 &ldquo;main&rdquo; 属于 .text 呢！？好吧，我的搜索结果是空的，我确信这就是道路的尽头。是时候收工了，game over。</p>
<p>但那晚没有找到解决方案我就无法入睡。我继续搜索，再搜索，直到我在一个 stackoverflow 的帖子上找到一个非常明显和简单的解决方案，可惜我已经找不到网址了。我所要做的就是把 main 函数声明 为const 把它改成 <code>const char main[] = {</code> 从而让它进入正确的 section，所以让我们再试着编译。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcc -Wall const_array_main.c -o fourth
</span></span><span style="display:flex;"><span>const_array_main.c:1:12: warning: ‘main’ is usually a <span style="color:#66d9ef">function</span> <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  const char main<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            ^
</span></span><span style="display:flex;"><span>$ ./fourth
</span></span><span style="display:flex;"><span>SL<span style="color:#f92672">)</span>.....<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>emmmm, 它现在在做什么! 是时候再次使用 gdb，看看发生了什么。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>gdb .<span style="color:#f92672">/</span><span style="color:#a6e22e">fourth</span>
</span></span><span style="display:flex;"><span>(gdb) <span style="color:#66d9ef">break</span> <span style="color:#a6e22e">_start</span>
</span></span><span style="display:flex;"><span>(gdb) <span style="color:#a6e22e">run</span>
</span></span><span style="display:flex;"><span>(gdb) layout <span style="color:#66d9ef">asm</span>
</span></span></code></pre></div><p>所以看一下代码，我们可以看到 main 的地址在 ASM 的 _start 指令中，在我的机器上看起来是这样的 <code>mov $0x4005a0,%rdi</code> 我们可以用这个在 main 上设置一个断点，通过做 <code>break *0x4005a0</code>，然后用 c 继续执行。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>(gdb) <span style="color:#66d9ef">break</span> <span style="color:#f92672">*</span><span style="color:#ae81ff">0x4005a0</span>
</span></span><span style="display:flex;"><span>(gdb) <span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>(gdb) x<span style="color:#f92672">/</span><span style="color:#ae81ff">49</span>i <span style="color:#960050;background-color:#1e0010">$</span>pc     <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">$</span>pc is the current executing instruction
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x4005a4</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;:</span>   mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x1</span>,<span style="color:#f92672">%</span>eax
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x4005a9</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;:</span>   mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x1</span>,<span style="color:#f92672">%</span>ebx
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x4005ae</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">14</span><span style="color:#f92672">&gt;:</span>  mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0x400510</span>,<span style="color:#f92672">%</span>esi
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x4005b3</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">19</span><span style="color:#f92672">&gt;:</span>  mov    <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0xd</span>,<span style="color:#f92672">%</span>edx
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x4005b8</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span><span style="color:#f92672">&gt;:</span>  syscall
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>我剪掉了一些不重要的汇编。如果你没有注意到出错的地方，push 到 print 的地址 (0x400510) 并不是我们存储字符串 <code>&quot;Hello world!\n &quot;</code> 的地址(0x4005c3)！它实际上仍然指向原始编译的可执行文件中的计算位置，而不是使用相对寻址来打印它。这意味着我们需要修改汇编代码，以便加载相对于当前地址的字符串的地址。就目前而言，在 32 位代码中完成这个任务相当困难，但幸运的是我们使用的是 64 位ASM，所以我们可以使用 lea 指令来轻松完成。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__asm__</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// print Hello World
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#34;movl $1, %eax;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>  <span style="color:#75715e">/* 1 is the syscall number for write */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;movl $1, %ebx;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>  <span style="color:#75715e">/* 1 is stdout and is the first argument */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// &#34;movl $message, %esi;\n&#34; /* load the address of string into the second argument*/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// instead use this to load the address of the string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// as 16 bytes from the current instruction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#34;leal 16(%eip), %esi;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;movl $13, %edx;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>  <span style="color:#75715e">/* third argument is the length of the string to print*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;syscall;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// call exit (so it doesn&#39;t try to run the string Hello World
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// maybe I could have just used ret instead
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#34;movl $60,%eax;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;xorl %ebx,%ebx; </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;syscall;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Store the Hello World inside the main function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#34;message: .ascii </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">Hello World!</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">;&#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcc -Wall relative_str_asm.c -o fifth
</span></span><span style="display:flex;"><span>relative_str_asm.c:1:6: warning: <span style="color:#66d9ef">return</span> type of ‘main’ is not ‘int’ <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  void main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      ^
</span></span><span style="display:flex;"><span>$ ./fifth
</span></span><span style="display:flex;"><span>Hello World!
</span></span></code></pre></div><p>现在我们可以使用前面讨论过的技术，将十六进制的值提取成一个整数数组。但是这一次，我想通过使用整整 4 个字节的 ints 来使它变得更有伪装性和技巧性。我们可以通过在 gdb 中把信息作为一个 int 打印出来，而不是把十六进制转储到一个文件中，然后再复制粘贴到程序中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>gdb .<span style="color:#f92672">/</span><span style="color:#a6e22e">fifth</span>
</span></span><span style="display:flex;"><span>(gdb) x<span style="color:#f92672">/</span><span style="color:#ae81ff">13</span>dw main
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x4004ed</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">&gt;:</span>    <span style="color:#f92672">-</span><span style="color:#ae81ff">443987883</span>  <span style="color:#ae81ff">440</span> <span style="color:#ae81ff">113408</span>  <span style="color:#f92672">-</span><span style="color:#ae81ff">1922629632</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x4004fd</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">4149</span>    <span style="color:#ae81ff">899584</span>  <span style="color:#ae81ff">84869120</span>    <span style="color:#ae81ff">15544</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x40050d</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">32</span><span style="color:#f92672">&gt;:</span> <span style="color:#ae81ff">266023168</span>   <span style="color:#ae81ff">1818576901</span>  <span style="color:#ae81ff">1461743468</span>  <span style="color:#ae81ff">1684828783</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x40051d</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span><span style="color:#f92672">&gt;:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1017312735</span>
</span></span></code></pre></div><p>我选择了数字 13，因为 main 的长度为 49 字节，为了安全起见，49/4 取整为 13。由于我们提前退出了这个函数，所以应该不会有什么影响。现在剩下的就是把这个复制粘贴到我们的 compiled_array_main.c 中并运行它。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> main[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span><span style="color:#ae81ff">443987883</span>, <span style="color:#ae81ff">440</span>, <span style="color:#ae81ff">113408</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1922629632</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4149</span>, <span style="color:#ae81ff">899584</span>, <span style="color:#ae81ff">84869120</span>, <span style="color:#ae81ff">15544</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">266023168</span>, <span style="color:#ae81ff">1818576901</span>, <span style="color:#ae81ff">1461743468</span>, <span style="color:#ae81ff">1684828783</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span><span style="color:#ae81ff">1017312735</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcc -Wall final_array.c -o sixth
</span></span><span style="display:flex;"><span>final_array.c:1:11: warning: ‘main’ is usually a <span style="color:#66d9ef">function</span> <span style="color:#f92672">[</span>-Wmain<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  const int main<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            ^
</span></span><span style="display:flex;"><span>$ ./sixth
</span></span><span style="display:flex;"><span>Hello World!
</span></span></code></pre></div><p>自始至终，我们都忽略了关于 warning: ‘main’ is usually a function 的警告信息 :)</p>
<p>我猜，当我的朋友交出这样的作业时，会因为糟糕的编码风格而扣分，然而并不会说别的&hellip;&hellip;</p>
<p>This is a version from <a href="http://jroweboy.github.io/about/">James Rowe</a>.</p>

</main>
<footer>
    <span>Copyright &copy; SunBK201 Ushiromiya 鲁 ICP备 20015383 号-1</span>
    <a hidden href="https://www.sunbk201.site"><img
            src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fwww.sunbk201.site&count_bg=%2379C83D&title_bg=%234F4F4F&icon=bloglovin.svg&icon_color=%23E7E7E7&title=hits&edge_flat=false" />
    </a>
</footer></body>
</html>
